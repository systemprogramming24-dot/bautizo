<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirmaci√≥n de Asistencia</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  background: linear-gradient(135deg, #f3e4ff, #f9dcff);
  font-family: 'Playfair Display', serif;
  color: #4a336f;
  text-align: center;
  margin: 0;
  padding: 20px;
}

h1 {
  font-family: 'Great Vibes', cursive;
  font-size: 3em;
  color: #6b3fa0;
  margin-bottom: 0.3em;
}



.card {
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(120, 87, 159, 0.2);
  padding: 25px;
  margin: 20px auto;
  max-width: 400px;
  transition: background 0.3s ease;
}

.guest-name {
  font-family: 'Great Vibes', cursive;
  font-size: 1.8em;
  color: #553285;
  margin-bottom: 15px;
}

.status-message {
  margin-top: 15px;
  font-size: 1em;
  font-weight: 500;
  color: #59337a;
}

.button-group {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 15px;
}

button {
  border: none;
  color: white;
  font-weight: 600;
  border-radius: 30px;
  padding: 10px 18px;
  cursor: pointer;
  font-size: 0.95em;
  transition: all 0.3s ease;
}

button:hover { transform: scale(1.05); }

.confirm { background-color: #6fcf97; } /* verde */
.decline { background-color: #5773eb; } /* azul - CAMBIO REALIZADO AQU√ç */
.change { background-color: #6c63ff; } /* lila intenso */

.loading { opacity: 0.7; pointer-events: none; }

#summary {
  margin-top: 30px;
  font-size: 1.1em;
  font-weight: 500;
  color: #4a336f;
}
</style>
</head>
<body>

<h1>Confirmaci√≥n de Asistencia</h1>

<p>Nos encantar√≠a contar contigo üíï<br>
Por favor confirma o cambia tu respuesta antes del <strong id="fecha-limite-global"></strong>,<br>
para poder preparar con tiempo tu lugar, tu mesa y todo con el cari√±o que mereces üíú , ya que √∫nicamente el ingreso ser√° para las personas confirmadas en lista.</p>

<div id="guest-list"></div>
<div id="summary"></div>

<script>
const SUPABASE_URL = "https://rsjyfchiynskjddpjupt.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzanlmY2hpeW5za2pkZHBqdXB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTkzMzEsImV4cCI6MjA3NTI5NTMzMX0.pxnbFP03pSWra1zOrCsR8ADyWF3wpGN88BQlameVRWM";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const groupCode = new URLSearchParams(window.location.search).get("group_code");
const guestList = document.getElementById("guest-list");
const summary = document.getElementById("summary");

async function loadGuests() {
  const { data, error } = await supabase
    .from("guests_baptism")
    .select("*")
    .eq("group_code", groupCode)
    .order("id");

  if (error || !data) { guestList.innerHTML = "<p>Error al cargar los datos.</p>"; return; }

  // fecha l√≠mite global si todos iguales
  const deadlines = [...new Set(data.map(g => g.confirmation_deadline).filter(Boolean))];
  document.getElementById("fecha-limite-global").textContent = deadlines[0] ? new Date(deadlines[0]).toLocaleDateString() : "‚Äî";

  guestList.innerHTML = "";

  data.forEach(guest => {
    const card = document.createElement("div");
    card.className = "card";

    if (guest.confirm === true) card.style.backgroundColor = "#d4f3e4";
    else if (guest.confirm === false) card.style.backgroundColor = "#f8d6d6";
    else card.style.backgroundColor = "#ffffff";

    const name = document.createElement("div");
    name.className = "guest-name";
    name.textContent = guest.guest;

    const status = document.createElement("div");
    status.className = "status-message";
    if (guest.confirm === true) status.textContent = "Asistir√° ‚ù§Ô∏è";
    else if (guest.confirm === false) status.textContent = "No asistir√° üíî";
    else status.textContent = "Pendiente de confirmaci√≥n";

    const buttonGroup = document.createElement("div");
    buttonGroup.className = "button-group";

    const confirmBtn = document.createElement("button");
    confirmBtn.className = "confirm";
    confirmBtn.textContent = "‚ù§Ô∏è Asistir√°";

    const declineBtn = document.createElement("button");
    declineBtn.className = "decline";
    declineBtn.textContent = "üíî No asistir√°";

    const changeBtn = document.createElement("button");
    changeBtn.className = "change";
    changeBtn.textContent = "Cambiar respuesta";

    if (guest.confirm === null) {
      confirmBtn.style.display = "inline-block";
      declineBtn.style.display = "inline-block";
      changeBtn.style.display = "none";
    } else {
      confirmBtn.style.display = "none";
      declineBtn.style.display = "none";
      changeBtn.style.display = "inline-block";
    }

    confirmBtn.onclick = async () => await updateResponse(true, guest, status, confirmBtn, declineBtn, changeBtn, card);
    declineBtn.onclick = async () => await updateResponse(false, guest, status, confirmBtn, declineBtn, changeBtn, card);
    changeBtn.onclick = async () => await resetResponse(guest, status, confirmBtn, declineBtn, changeBtn, card);

    buttonGroup.append(confirmBtn, declineBtn, changeBtn);
    card.append(name, status, buttonGroup);
    guestList.appendChild(card);
  });

  renderSummary(data);
}

async function updateResponse(value, guest, status, confirmBtn, declineBtn, changeBtn, card){
  status.textContent = "Enviando respuesta...";
  confirmBtn.classList.add("loading");
  declineBtn.classList.add("loading");

  // actualizar tabla principal
  await supabase.from("guests_baptism").update({ confirm: value, confirmed_at: new Date().toISOString() }).eq("id", guest.id);

  // agregar registro a la tabla de historial
  await supabase.from("guests_baptism_history").insert({ guest_id: guest.id, status: value });

  guest.confirm = value;
  status.textContent = value ? "Asistir√° ‚ù§Ô∏è" : "No asistir√° üíî";
  card.style.backgroundColor = value ? "#d4f3e4" : "#f8d6d6";
  confirmBtn.style.display = "none";
  declineBtn.style.display = "none";
  changeBtn.style.display = "inline-block";

  confirmBtn.classList.remove("loading");
  declineBtn.classList.remove("loading");

  renderSummary(await getUpdatedGuests());
}

async function resetResponse(guest, status, confirmBtn, declineBtn, changeBtn, card){
  status.textContent = "Pendiente de confirmaci√≥n";
  card.style.backgroundColor = "#ffffff";

  // Actualizar tabla principal
  await supabase.from("guests_baptism").update({ confirm: null }).eq("id", guest.id);

  // Registrar en la tabla de historial como pendiente
  await supabase.from("guests_baptism_history").insert({ guest_id: guest.id, status: null });

  confirmBtn.style.display = "inline-block";
  declineBtn.style.display = "inline-block";
  changeBtn.style.display = "none";

  renderSummary(await getUpdatedGuests());
}

async function getUpdatedGuests() {
  const { data } = await supabase.from("guests_baptism").select("*").eq("group_code", groupCode);
  return data || [];
}

function renderSummary(data){
  const confirmed = data.filter(g => g.confirm === true).length;
  const declined = data.filter(g => g.confirm === false).length;
  const pending = data.filter(g => g.confirm === null).length;

  if (pending === data.length)
    summary.textContent = "Esperamos con ilusi√≥n tu confirmaci√≥n üíú";
  else if (confirmed > 0 && declined === 0)
    summary.textContent = `Gracias por tu respuesta, ¬°nos encantar√° compartir este d√≠a contigo! (${confirmed} asistir√°n)`;
  else if (confirmed > 0 && declined > 0)
    summary.textContent = `Algunos asistir√°n (${confirmed}) y otros no (${declined}). ¬°Gracias por confirmar!`;
  else if (confirmed === 0 && declined > 0)
    summary.textContent = "Lamentamos que no puedas acompa√±arnos, pero te agradecemos de coraz√≥n üíú";
}

loadGuests();
</script>

</body>
</html>
