<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Confirmaci칩n de Asistencia</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  background: linear-gradient(135deg, #f3e4ff, #f9dcff);
  font-family: 'Playfair Display', serif;
  color: #4a336f;
  text-align: center;
  margin: 0;
  padding: 20px;
}

h1 {
  font-family: 'Great Vibes', cursive;
  font-size: 3em;
  color: #6b3fa0;
  margin-bottom: 0.3em;
}

.card {
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(120, 87, 159, 0.2);
  padding: 25px;
  margin: 20px auto;
  max-width: 400px;
  transition: background 0.3s ease;
}

.guest-name {
  font-family: 'Parisienne', cursive;
  font-size: 1.8em;
  color: #553285;
  margin-bottom: 15px;
}

.status-message {
  margin-top: 15px;
  font-size: 1em;
  font-weight: 500;
  color: #59337a;
}

.deadline-info {
  font-size: 0.85em;
  color: #6a5a8a;
  margin-top: 8px;
  margin-bottom: 0;
}

.button-group {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 15px;
}

button {
  border: none;
  color: white;
  font-weight: 600;
  border-radius: 30px;
  padding: 10px 18px;
  cursor: pointer;
  font-size: 0.95em;
  transition: all 0.3s ease;
}

button:hover { transform: scale(1.05); }
button:disabled {
  background-color: #cccccc;
  cursor: not-allowed;
  transform: none;
}

.confirm { background-color: #6fcf97; } /* verde */
.decline { background-color: #5773eb; } /* azul */
.change { background-color: #6c63ff; } /* lila intenso */

.loading { opacity: 0.7; pointer-events: none; }

#summary {
  margin-top: 30px;
  font-size: 1.1em;
  font-weight: 500;
  color: #4a336f;
}
</style>
</head>
<body>

<h1>Confirmaci칩n de Asistencia</h1>

<p id="parrafo-global">Nos encantar칤a contar contigo 游눗<br>
<span id="texto-fecha-limite"></span><br>
para poder preparar con tiempo tu lugar, tu mesa y todo con el cari침o que mereces 游눞 , ya que 칰nicamente ser치n consideradas las personas que indicaron que asistir치n</p>

<div id="guest-list"></div>
<div id="summary"></div>

<script>
//const SUPABASE_URL = "https://rsjyfchiynskjddpjupt.supabase.co";
//const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzanlmY2hpeW5za2pkZHBqdXB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTkzMzEsImV4cCI6MjA3NTI5NTMzMX0.pxnbFP03pSWra1zOrCsR8ADyWF3wpGN88BQlameVRWM";
const SUPABASE_URL = "https://ubyvqwwkklsrimfxnuye.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVieXZxd3dra2xzcmltZnhudXllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2MTIxMTYsImV4cCI6MjA3NzE4ODExNn0.OExoTR1zJobgv-c0ynFdNmZDiXrcbFl5uNP7SfexBp0";

  
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const groupCode = new URLSearchParams(window.location.search).get("group_code");
const guestList = document.getElementById("guest-list");
const summary = document.getElementById("summary");

async function loadGuests() {
  const { data, error } = await supabase
    .from("guests_baptism")
    .select("*")
    .eq("group_code", groupCode)
    .order("id");

  if (error || !data || data.length === 0) { 
    guestList.innerHTML = "<p>Error al cargar los datos o grupo no encontrado.</p>"; 
    return; 
  }

  const deadlines = [...new Set(data.map(g => g.confirmation_deadline).filter(Boolean))];
  const isGlobalDeadline = deadlines.length === 1 && data.length > 1;
  const deadlineTextContainer = document.getElementById('texto-fecha-limite');

  if (isGlobalDeadline) {
    const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    const formattedDeadline = new Date(deadlines[0]).toLocaleString('es-ES', options) + ' hrs';
    deadlineTextContainer.innerHTML = `Por favor confirma o cambia tu respuesta antes del <strong>${formattedDeadline}</strong>,`;
  } else {
    deadlineTextContainer.innerHTML = 'Por favor confirma tu respuesta antes de la fecha l칤mite indicada para cada invitado,';
  }

  guestList.innerHTML = "";

  data.forEach(guest => {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.guestId = guest.id; 
    
    const now = new Date();
    const deadline = guest.confirmation_deadline ? new Date(guest.confirmation_deadline) : null;
    const hasDeadlinePassed = deadline && now > deadline;
    
    // CAMBIO 1: Determinar si el invitado es auto-rechazado
    const isAutoDeclined = guest.confirm === null && hasDeadlinePassed;

    // Asignar color de fondo basado en el estado final (incluyendo auto-rechazo)
    if (guest.confirm === true) card.style.backgroundColor = "#d4f3e4";
    else if (guest.confirm === false || isAutoDeclined) card.style.backgroundColor = "#f8d6d6";
    else card.style.backgroundColor = "#ffffff";
    
    const name = document.createElement("div");
    name.className = "guest-name";
    name.textContent = guest.guest;

    const status = document.createElement("div");
    status.className = "status-message";
    
    // Asignar mensaje de estado basado en la l칩gica completa
    if (guest.confirm === true) {
        status.textContent = "Asistir치 仇벒잺";
    } else if (guest.confirm === false) {
        status.textContent = "No asistir치 游눖";
    } else if (isAutoDeclined) {
        // Mensaje espec칤fico para los que no confirmaron a tiempo
        status.textContent = "Como no confirm칩 a tiempo, se considera que no asistir치 游땞";
    } else {
        status.textContent = "Pendiente de confirmaci칩n";
    }

    card.append(name, status);

    if (!isGlobalDeadline && deadline) {
        const deadlineInfo = document.createElement("p");
        deadlineInfo.className = "deadline-info";
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        deadlineInfo.textContent = 'Fecha l칤mite: ' + deadline.toLocaleString('es-ES', options) + ' hrs';
        card.appendChild(deadlineInfo);
    }
    
    // Los botones solo se muestran si el plazo NO ha pasado
    if (!hasDeadlinePassed) {
        const buttonGroup = document.createElement("div");
        buttonGroup.className = "button-group";

        const confirmBtn = document.createElement("button");
        confirmBtn.className = "confirm";
        confirmBtn.textContent = "仇벒잺 Asistir치";

        const declineBtn = document.createElement("button");
        declineBtn.className = "decline";
        declineBtn.textContent = "游눖 No asistir치";

        const changeBtn = document.createElement("button");
        changeBtn.className = "change";
        changeBtn.textContent = "Cambiar respuesta";

        if (guest.confirm === null) {
            confirmBtn.style.display = "inline-block";
            declineBtn.style.display = "inline-block";
            changeBtn.style.display = "none";
        } else {
            confirmBtn.style.display = "none";
            declineBtn.style.display = "none";
            changeBtn.style.display = "inline-block";
        }

        confirmBtn.onclick = async () => await updateResponse(true, guest);
        declineBtn.onclick = async () => await updateResponse(false, guest);
        changeBtn.onclick = async () => await resetResponse(guest);

        buttonGroup.append(confirmBtn, declineBtn, changeBtn);
        card.appendChild(buttonGroup);
    }
    
    guestList.appendChild(card);
  });

  renderSummary(data);
}

async function updateResponse(value, guest){
  const now = new Date();
  const deadline = guest.confirmation_deadline ? new Date(guest.confirmation_deadline) : null;
  if (deadline && now > deadline) {
    alert("El plazo para confirmar tu asistencia ha finalizado. Ya no es posible realizar cambios.");
    loadGuests();
    return; 
  }
  
  const statusMessage = document.querySelector(`.card[data-guest-id="${guest.id}"] .status-message`);
  if(statusMessage) statusMessage.textContent = "Enviando respuesta...";

  const { error } = await supabase.from("guests_baptism").update({ confirm: value, confirmed_at: new Date().toISOString() }).eq("id", guest.id);

  if (error) {
    alert("Hubo un error al enviar tu respuesta. Es posible que el plazo haya finalizado.");
    loadGuests();
    return;
  }
  
  await supabase.from("guests_baptism_history").insert({ guest_id: guest.id, status: value });
  loadGuests();
}

async function resetResponse(guest){
  const now = new Date();
  const deadline = guest.confirmation_deadline ? new Date(guest.confirmation_deadline) : null;
  if (deadline && now > deadline) {
    alert("El plazo para cambiar tu respuesta ha finalizado.");
    loadGuests();
    return;
  }

  const { error } = await supabase.from("guests_baptism").update({ confirm: null }).eq("id", guest.id);

  if (error) {
    alert("Hubo un error al cambiar tu respuesta. Es posible que el plazo haya finalizado.");
    loadGuests();
    return;
  }
  
  await supabase.from("guests_baptism_history").insert({ guest_id: guest.id, status: null });
  loadGuests();
}

// CAMBIO 2: L칩gica del resumen actualizada para contar correctamente a los pendientes vencidos
function renderSummary(data){
  const now = new Date();

  const confirmed = data.filter(g => g.confirm === true).length;
  
  const declined = data.filter(g => 
    g.confirm === false || 
    (g.confirm === null && g.confirmation_deadline && new Date(g.confirmation_deadline) < now)
  ).length;
  
  const pending = data.filter(g => 
    g.confirm === null && 
    (!g.confirmation_deadline || new Date(g.confirmation_deadline) >= now)
  ).length;

  if (pending > 0 && confirmed === 0 && declined === 0)
    summary.textContent = "Esperamos con ilusi칩n tu confirmaci칩n 游눞";
  else if (confirmed > 0 && declined === 0 && pending === 0)
    summary.textContent = `춰Gracias a todos por confirmar! Nos encantar치 compartir este d칤a con ustedes (${confirmed} asistir치n).`;
  else if (confirmed > 0 && declined === 0)
    summary.textContent = `Gracias por tu respuesta, 춰nos encantar치 compartir este d칤a contigo! (${confirmed} asistir치n)`;
  else if (confirmed > 0 && declined > 0)
    summary.textContent = `Algunos asistir치n (${confirmed}) y otros no (${declined}). 춰Gracias por confirmar!`;
  else if (confirmed === 0 && declined > 0)
    summary.textContent = `Lamentamos que no puedan acompa침arnos (${declined}), pero les agradecemos de coraz칩n 游눞`;
  else 
    summary.textContent = "Gracias por tus respuestas.";
}

loadGuests();
</script>

</body>
</html>
